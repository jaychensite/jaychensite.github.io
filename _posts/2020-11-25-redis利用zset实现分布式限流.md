---
layout: post
title: "redis实现限流"
date: 2020-11-25 
description: "redis实现限流"
tag: Redis
---   
### redis 实现限流

#### 概念
限流直白的翻译就是限制。为什么需要限制？因为资源不够用。举一个列子，某都前段时间出现了一个网红桥，大家纷纷去打卡。此时那叫一个人山人海。如果此时出现脚踏事故，后顾很严重。所以就有保安人员在那里限制人流。对于一个系统来讲，一个系统的吞吐量是可以测试出来的，一旦系统的并发量达到了系统安全的临界值，此时就会针对系统限流，来达到对系统的保护，防止系统崩溃。

#### 如何服务限流

* 熔断
	当系统出现问题时，短时间无法恢复，系统则需要自动判断并开启熔断机制，拒绝所有的访问。防止下游系统大量的请求hang住导致资源耗尽产生雪崩效应。待系统检测到服务的恢复则关闭掉熔断开关。（市面上实现熔断的中间件有很多如：Hystrix等）

* 降级
	什么是服务降级了？当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级， 以此释放服务器资源以保证核心任务的正常运行。说白了就是在高峰期将一些冷门不重要的页面功能或者请求进行拒绝处理，尽可能的让有限的资源让给核心业务利用。在高峰期如果不进行服务降级，很可能会影响到整个系统的性能影响。严重的话会导致系统宕机。所以一般在高峰期会将冷门不重要的服务进行降级。

* 延迟处理
	系统并发量达到了阈值，将超出的请求放进队列里慢慢进行处理。对系统进行削峰。

#### 如何进行实现
一般限流方案都是基于漏桶与令牌桶的思想（具体的百度）。实现限流方案有很多种，今天主要是利用 ***redis实现分布式限流方案*** 
![service life image][image]
#### redis zset实现限流
限流一般要求时间窗口的滑动（比如说要求限流时间范围是1s。随着时间的移动，始终统计1s内的数量）。

zset 数据结构的 score 值，可以通过 score 来圈出这个时间窗口来。而且我们只需要保留这个时间窗口，窗口之外的数据都可以砍掉。那这个 zset 的 value 填什么比较合适呢？它只需要保证唯一性即可。***窗口之外的数据要删掉。切记！！！切记！！！切记！！！*** 

#### 代码实现
```
public static void main(String[] args) {
        final Jedis jedis = new Jedis("localhost", 6379);
        final String GLOBE_KEY = "current_limit";
        final Integer maxCount = 5;

        /**
         * 在生产环境中利用脚本实现原子性
         */
        for (int i = 0; i < 8; i++) {
            long nowTs = System.currentTimeMillis();
            long count = jedis.zcount(GLOBE_KEY, nowTs - 1000, nowTs);
            if (count < maxCount) {
                System.out.println("通过");
                jedis.zadd(GLOBE_KEY, nowTs, UUID.randomUUID().toString());
                // 删除时间窗口之外的
                jedis.zremrangeByScore(GLOBE_KEY, 0, nowTs - 1000);
            } else {
                System.out.println("限流中。。。。");
            }
        }

    }
通过
通过
通过
通过
通过
限流中。。。。
限流中。。。。
限流中。。。。	
```


[image]:data:image/png;base64,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uOY5V0aKCoZw4d133/XSuPXWW/USGUnoBXFoRqsRaVTSeozKs2nZu07rZ0YlfP75597fLucq6fpczXkOA2kgoqCRynHNM400AI1URlSeaaQFzL400miyWr400gBxGCneB7/yyiu9hzgG/I5l+Aif+d3k1w7sWwlmPxdopNHEUZ9ppNFktXxppAHKGSn6XjEphzkOwhimnedyRophRn///bde+j/Y16ynkdaGRloM0kBEQSOV45pnGmkAiZEi8DtalzA/zE5kjm0H1mHyD5gn9jEPdb744gud4v9AL400HBppMUgDEQWNVI5rnmmkAaox0nItUrQ+jZFinzCwL400HBppMUgDEQWNVI5rnmmkAaox0vXr13vDpcwteykjxfhW8waRHZjvkkYaDo20GKSBiIJGKsc1zzTSANX0kZpbexgriDJSs51ZRyMtDY20GKSBiIJGKsc1zzTSANW0SDGFHGY9ginCHNkipZHamH1ppNFktXxppAGq7SP96KOPvP1ghGyR0khtzL400miyWr6NcPC6CCQetlwS1e4rrWDlMEZ64403FqUPs8OHzhD4HR88w0QfmG0Kn36YPHmy9ztu9c3yH374wZs1HvvgCX7wcxQIGCm2xT7YN3jccmHScMFc4PimUdgxwiKqjMx0b3EZKb5SinRd6pVLxFGfcX6hJS4jDR4nzohDbzWR1fJlizRAtS1SO8/SFqkB+7JFGg5bpMUgDUQUWbt+QVbLl0YaoJqHTbaRmm1gmDBR20ixLgzsa4w0aLJRmHy4QCONxuW4Zl8aaTRZLV8aaYBqW6SvvPKKf3xEsB80zEhNemYfY76VYPZ1gUYaTRz1mUYaTVbLl0YaoJyRliMJvSAOzTTSaOIoXxppNFktXxppABqpjKg800gLmH1ppNFktXxppAFopDKi8kwjLWD2pZFGk9XypZEGoJHKiMozjbSA2ZdGGk1Wy5dGGqBSI8VMTtgeY0FLgQdPJm9REZwZKgqznws00mjiqM800miyWr400gDljNQMUTLHiQr76T7+LmWS0Ivxo+W2KYU5lgs00mjiqM800miyWr400gASIzVDm2B+xiy//fZbf50Z1kQjpZECsy+NNJqsli+NNEDUrb3dKoX5mb8xaQlM0xiiPSaURlo9NNJikAYiChqpHNc800gDlDNSmJw5hiSMmdJIq4dGWgzSQERBI5Xj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


